<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>月間コイン計算 v4</title>

  <style>
    :root{
      --bg:#070b10;
      --line: rgba(255,255,255,.10);
      --text:#eaf2ff;
      --muted:#93a6bd;
      --brand:#6ee7ff;
      --ok:#72f1a6;
      --warn:#ffb86b;
      --bad:#ff7b7b;
      --shadow: 0 18px 50px rgba(0,0,0,.55);
      --r: 18px;
      --panel: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans JP",sans-serif;
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 50% 0%, rgba(110,231,255,.12), transparent 60%),
        radial-gradient(900px 600px at 10% 40%, rgba(114,241,166,.10), transparent 60%),
        radial-gradient(900px 600px at 90% 60%, rgba(255,184,107,.08), transparent 60%),
        var(--bg);
    }
    .wrap{ max-width:980px; margin:0 auto; padding:18px 14px 80px; }
    header{ padding:6px 2px 14px; }
    h1{ margin:0; letter-spacing:.02em; line-height:1.3; font-size: 20px; }
    .sub{ margin-top:6px; font-size:13px; color:var(--muted); line-height:1.5; }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      backdrop-filter: blur(12px);
    }

    /* Tabs */
    .tabs{
      display:flex; gap:10px; padding:12px;
      overflow-x:auto; -webkit-overflow-scrolling: touch;
      scroll-snap-type: x mandatory;
      touch-action: pan-x;
    }
    .tab{
      flex:0 0 auto; scroll-snap-align:start;
      border:1px solid var(--line);
      background: rgba(255,255,255,.05);
      color: var(--text);
      padding: 12px 16px;
      border-radius: 999px;
      font-size: 14px;
      min-height: 44px;
      display:inline-flex; align-items:center; gap:8px;
      font-weight: 900;
      cursor:pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      white-space: nowrap;
    }
    .tab.active{
      background: rgba(110,231,255,.16);
      border-color: rgba(110,231,255,.45);
    }
    .dot{ width:8px; height:8px; border-radius:50%; background: rgba(255,255,255,.28); }
    .tab.active .dot{ background: var(--brand); }

    /* Layout */
    .grid{
      margin-top:12px;
      display:grid; gap:12px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 900px){
      .grid{ grid-template-columns: 1.2fr .8fr; }
    }
    .panel{ padding:14px; }

    .row{ display:grid; gap:10px; grid-template-columns:1fr; }
    @media (min-width: 640px){ .row.cols2{ grid-template-columns: 1fr 1fr; } }

    label{ display:block; font-size:13px; color: var(--muted); margin: 0 0 6px; }

    input[type="number"], input[type="text"]{
      width:100%;
      border-radius: 14px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.30);
      color: var(--text);
      padding: 12px 12px;
      outline:none;
      min-height: 50px;
      font-size: 17px;
    }

    .helper{ margin-top:6px; color: var(--muted); font-size: 13px; line-height:1.4; }

    /* Big toggle (押しやすい) */
    .bigToggle{
      margin-top:10px;
      display:flex; gap:10px; align-items:stretch;
    }
    .bigToggle button{
      flex:1 1 auto;
      min-height: 56px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-weight: 950;
      font-size: 15px;
      cursor:pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .bigToggle .on{
      border-color: rgba(114,241,166,.45) !important;
      background: rgba(114,241,166,.16) !important;
      color: #eafff4 !important;
    }
    .bigToggle .off{
      border-color: rgba(255,255,255,.16) !important;
      background: rgba(255,255,255,.06) !important;
      color: rgba(234,242,255,.90) !important;
    }

    /* KPI */
    .kpi{
      margin-top: 12px;
      display:grid; gap:10px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 640px){ .kpi{ grid-template-columns: repeat(3, 1fr); } }

    .box{
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      border-radius: 16px;
      padding: 12px;
      min-height: 110px;
    }
    .ttl{ color: var(--muted); font-size:13px; }
    .val{ margin-top:6px; font-size: 28px; font-weight: 1000; letter-spacing:.02em; }
    @media (min-width: 900px){ .val{ font-size: 24px; } }
    .subtxt{ margin-top:6px; color: var(--muted); font-size:13px; line-height:1.4; }

    /* Buttons */
    .btns{ display:flex; flex-wrap:wrap; gap:10px; margin-top: 12px; }
    button{
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 12px 14px;
      min-height: 46px;
      cursor:pointer;
      font-weight: 1000;
      letter-spacing:.02em;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }

    /* buttons contrast & tap (TAB以外) */
    button:not(.tab){
      color: #f4fbff !important;
      background: rgba(255,255,255,.12) !important;
      border-color: rgba(255,255,255,.22) !important;
    }
    button:not(.tab):active{ transform: translateY(1px); }

    .primary{
      background: rgba(110,231,255,.20) !important;
      border-color: rgba(110,231,255,.55) !important;
    }
    .danger{
      background: rgba(255,123,123,.16) !important;
      border-color: rgba(255,123,123,.55) !important;
    }
    .ghost{
      background: rgba(255,255,255,.14) !important;
      border-color: rgba(255,255,255,.25) !important;
    }

    /* Header blocks */
    .headrow{ display:flex; align-items:flex-start; justify-content: space-between; gap:10px; }
    .title{ font-size:16px; font-weight: 1000; }
    .meta{ font-size:13px; color: var(--muted); margin-top:4px; }

    .hint{ margin-top: 10px; color: var(--muted); font-size: 13px; line-height:1.6; }

    /* Modal */
    .modalBack{
      position: fixed; inset: 0;
      background: rgba(0,0,0,.55);
      display:none;
      align-items: flex-end;
      justify-content: center;
      z-index: 99999;
    }
    .modal{
      width:100%;
      max-width: 740px;
      border-radius: 20px 20px 0 0;
      background: rgba(16,20,27,.96);
      border: 1px solid rgba(255,255,255,.10);
      box-shadow: 0 20px 80px rgba(0,0,0,.7);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    .modalTop{
      display:flex; align-items:center; justify-content:space-between; gap:10px;
      padding: 6px 2px 10px;
    }
    .modalTop .mt{ font-weight: 1000; }
    .modalGrid{
      display:grid; gap:10px;
      grid-template-columns: 1fr;
    }
    @media (min-width: 640px){
      .modalGrid{ grid-template-columns: 1fr 1fr; }
    }
    .mrow{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.25);
      border-radius: 16px;
      padding: 12px;
    }
    .mrow .k{ color: var(--muted); font-size: 13px; }
    .mrow .v{ margin-top:6px; font-size: 20px; font-weight: 1000; }
    .miniInput{ margin-top:10px; }
    .miniInput input{ min-height: 46px; font-size: 16px; }
    .modalBtns{ display:flex; gap:10px; margin-top: 12px; }

    #openDeduct{
      padding: 12px 14px !important;
      min-height: 46px !important;
      border-radius: 14px !important;
    }
    /* ===== MODAL 見やすさ強化（上書き用） ===== */
.modalBack{
  align-items: center;                 /* 下に寄せず中央寄せ */
  padding: 18px 14px;
}

.modal{
  max-width: 820px;
  border-radius: 22px;
  padding: 16px 16px 14px;
  background: rgba(10,14,20,.92);      /* 文字が沈まない濃さ */
  border: 1px solid rgba(255,255,255,.14);
  box-shadow: 0 28px 110px rgba(0,0,0,.78);
}

.modalTop{
  position: sticky; top: 0;            /* スクロールしてもヘッダ残る */
  background: linear-gradient(180deg, rgba(10,14,20,.98), rgba(10,14,20,.70));
  padding: 10px 6px 12px;
  margin: -8px -8px 10px;              /* 端まで背景 */
  border-bottom: 1px solid rgba(255,255,255,.10);
  border-radius: 18px 18px 0 0;
}

.modalTop .mt{
  font-size: 18px;
  font-weight: 1000;
  letter-spacing: .02em;
}

#closeDeduct{
  min-height: 44px;
  padding: 10px 14px;
  border-radius: 999px;
}

.modalGrid{
  gap: 12px;
}

.mrow{
  background: rgba(255,255,255,.06);   /* 1段明るく */
  border: 1px solid rgba(255,255,255,.12);
  padding: 14px;
  border-radius: 18px;
}

.mrow .k{
  font-size: 13px;
  color: rgba(234,242,255,.78);
  letter-spacing: .02em;
}

.mrow .v{
  margin-top: 8px;
  font-size: 22px;                     /* 金額を大きく */
  font-weight: 1000;
  letter-spacing: .02em;
}

.miniInput label{
  font-size: 13px;
  color: rgba(234,242,255,.70);
}

.miniInput input{
  margin-top: 6px;
  min-height: 52px;
  font-size: 18px;
  background: rgba(0,0,0,.34);
  border-color: rgba(255,255,255,.16);
}

.miniInput .helper{
  font-size: 13px;
  margin-top: 6px;
  color: rgba(147,166,189,.95);
}

/* 重要ブロック（総支給/控除合計/手取り）を目立たせる */
.mrow:nth-child(1),
.mrow:nth-child(2),
.mrow:last-child{
  background: rgba(110,231,255,.08);
  border-color: rgba(110,231,255,.18);
}

/* ボタンを固定フッター化して押しやすく */
.modalBtns{
  position: sticky;
  bottom: 0;
  background: linear-gradient(180deg, rgba(10,14,20,0), rgba(10,14,20,.92) 35%, rgba(10,14,20,.98));
  padding: 12px 0 2px;
  margin-top: 12px;
  gap: 10px;
}

#resetRates, #applyRates{
  flex: 1 1 auto;
  min-height: 52px;
  font-size: 16px;
  border-radius: 16px;
}

/* モーダルが縦長になった時は中身だけスクロール */
.modal{
  max-height: min(86vh, 780px);
  overflow: auto;
  -webkit-overflow-scrolling: touch;
}

  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <h1>収益計算表</h1>
      <div class="sub">基本＝コイン × 0.2 × 40%（＝×0.08） / 控除は自動反映。内訳は「控除内訳」で確認。</div>
    </header>

    <div class="card">
      <div id="tabs" class="tabs">
        <button class="tab active" type="button" data-app="wave"><span class="dot"></span>WAVE</button>
        <button class="tab" type="button" data-app="17live"><span class="dot"></span>17ライブ</button>
        <button class="tab" type="button" data-app="tiktok"><span class="dot"></span>TikTok</button>
        <button class="tab" type="button" data-app="pococha"><span class="dot"></span>ポコチャ</button>
        <button class="tab" type="button" data-app="bigo"><span class="dot"></span>ビゴライブ</button>
        <button class="tab" type="button" data-app="palm"><span class="dot"></span>パルム</button>
      </div>
    </div>

    <div class="grid">
      <!-- Left（計算） -->
      <div class="card panel">
        <div class="row cols2">
          <div>
            <label>月間取得コイン数</label>
            <input id="coins" type="number" inputmode="numeric" min="0" step="1" placeholder="例：3000000">
            <div class="helper" id="appNote">現在：WAVE</div>
          </div>
          <div>
            <label>メモ（任意）</label>
            <input id="memo" type="text" placeholder="例：12月 / イベントA">
            <div class="helper">履歴とCSVに一緒に保存されます。</div>
          </div>
        </div>

        <!-- WAVE extra (押しやすい) -->
        <div id="waveExtraBlock" style="display:none;">
          <div class="helper" style="margin-top:10px;">WAVEの期間限定エクストラ（必要な月だけON）。</div>
          <div class="bigToggle">
            <button id="extraOff" class="off" type="button">エクストラ：OFF</button>
            <button id="extraOn" class="off" type="button">エクストラ：ON</button>
          </div>
        </div>

        <!-- KPI -->
        <div class="kpi">
          <div class="box">
            <div class="ttl">基本（コイン × 0.2 × 40%）</div>
            <div class="val" id="baseYen">¥0</div>
            <div class="subtxt" id="baseFormula">0 × 0.2 × 40%</div>
          </div>

          <div class="box">
            <div class="ttl">通常ボーナス</div>
            <div class="val" id="bonusYen">¥0</div>
            <div class="subtxt" id="bonusHint">-</div>
          </div>

          <div class="box">
            <div class="ttl">エクストラ（WAVE/ON時）</div>
            <div class="val" id="extraYen">¥0</div>
            <div class="subtxt" id="extraHint">OFF</div>
          </div>
        </div>

        <div class="kpi" style="margin-top:10px;">
          <div class="box">
            <div class="ttl">総支給（合計）</div>
            <div class="val" id="grossYen">¥0</div>
            <div class="subtxt">自動計算</div>
          </div>

          <div class="box">
            <div class="ttl">控除合計</div>
            <div class="val" id="deductYen">¥0</div>
            <div class="subtxt"><button id="openDeduct" class="ghost" type="button">控除内訳</button></div>
          </div>

          <div class="box">
            <div class="ttl">差し引き振込額（手取り）</div>
            <div class="val" id="netYen">¥0</div>
            <div class="subtxt" id="netNote">総支給 − 控除</div>
          </div>
        </div>

        <div class="btns">
          <button class="primary" id="save" type="button">この結果を履歴に保存</button>
          <button id="clearInput" type="button">入力クリア</button>
          <button class="danger" id="wipe" type="button">履歴を全削除</button>
        </div>

        <div class="hint">
          ・入力と履歴はブラウザ内（LocalStorage）に保存されます。<br/>
          ・CSVは右の「今回の結果をCSV出力」だけでOK（履歴テーブルは表示しません）。
        </div>
      </div>

      <!-- Right（CSVだけ） -->
      <div class="card panel">
        <div class="headrow">
          <div>
            <div class="title">CSV</div>
            <div class="meta">今回の結果（現在の入力）を1行でCSV保存します。</div>
          </div>
        </div>

        <div class="btns" style="margin-top:12px;">
          <button id="exportSingleCsv" class="primary" type="button">今回の結果をCSV出力</button>
        </div>

        <div class="hint">
          ・このボタンは「今画面に出てる計算結果」を1行CSVにします。<br/>
          ・履歴は保存だけ（表示しない）なので、スマホでも見た目がスッキリ。
        </div>
      </div>
    </div>
  </div>

  <!-- Deductions modal -->
  <div id="modalBack" class="modalBack">
    <div class="modal">
      <div class="modalTop">
        <div class="mt">控除内訳</div>
        <button id="closeDeduct" type="button">閉じる</button>
      </div>

      <div class="modalGrid">
        <div class="mrow">
          <div class="k">総支給</div>
          <div class="v" id="mGross">¥0</div>
        </div>
        <div class="mrow">
          <div class="k">控除合計</div>
          <div class="v" id="mDeduct">¥0</div>
        </div>

        <div class="mrow">
          <div class="k">インボイス控除</div>
          <div class="v" id="mInvoice">¥0</div>
          <div class="miniInput">
            <label>率（%）</label>
            <input id="invoiceRate" type="number" inputmode="decimal" min="0" step="0.1" />
            <div class="helper">自動反映（必要ならここで変更）</div>
          </div>
        </div>

        <div class="mrow">
          <div class="k">源泉/税控除</div>
          <div class="v" id="mWithhold">¥0</div>
          <div class="miniInput">
            <label>率（%）</label>
            <input id="withholdingRate" type="number" inputmode="decimal" min="0" step="0.1" />
            <div class="helper">自動反映（必要ならここで変更）</div>
          </div>
        </div>

        <div class="mrow" style="grid-column: 1 / -1;">
          <div class="k">その他手数料（固定）</div>
          <div class="v" id="mFee">¥0</div>
          <div class="miniInput">
            <label>金額（円）</label>
            <input id="feeYen" type="number" inputmode="numeric" min="0" step="1" />
            <div class="helper">振込手数料など（必要なら入力）</div>
          </div>
        </div>

        <div class="mrow" style="grid-column: 1 / -1;">
          <div class="k">差し引き振込額（手取り）</div>
          <div class="v" id="mNet">¥0</div>
        </div>
      </div>

      <div class="modalBtns">
        <button id="resetRates" class="ghost" type="button">控除設定を初期値へ</button>
        <button id="applyRates" class="primary" type="button">反映</button>
      </div>
    </div>
  </div>

<script>
/* ========= 設定 ========= */
// 基本の計算：コイン × 0.2 × 40%（=0.08）
const BASE_RATE = 0.2;
const PAYOUT_PERCENT = 0.40;

// アプリ別（控除の初期値）
const appConfigs = {
  wave:     { name:"WAVE",   hasExtra:true,  invoiceRate: 10.0, withholdingRate: 10.21, feeYen: 0 },
  "17live": { name:"17ライブ", hasExtra:false, invoiceRate: 10.0, withholdingRate: 10.21, feeYen: 0 },
  tiktok:   { name:"TikTok", hasExtra:false, invoiceRate: 10.0, withholdingRate: 10.21, feeYen: 0 },
  pococha:  { name:"ポコチャ", hasExtra:false, invoiceRate: 10.0, withholdingRate: 10.21, feeYen: 0 },
  bigo:     { name:"ビゴライブ", hasExtra:false, invoiceRate: 10.0, withholdingRate: 10.21, feeYen: 0 },
  palm:     { name:"パルム", hasExtra:false, invoiceRate: 10.0, withholdingRate: 10.21, feeYen: 0 },
};

// WAVEボーナス表（画像準拠）
const waveNormalTiers = [
  { min: 200001, max: 300000, yen: 0 },
  { min: 300001, max: 400000, yen: 3000 },
  { min: 400001, max: 500000, yen: 5000 },
  { min: 500001, max: 600000, yen: 7000 },
  { min: 600001, max: 700000, yen: 10000 },
  { min: 700001, max: 800000, yen: 13000 },
  { min: 800001, max: 900000, yen: 15000 },
  { min: 900001, max: 1000000, yen: 18000 },
  { min: 1000001, max: 2000000, yen: 20000 },
  { min: 2000001, max: 3000000, yen: 20000 },
  { min: 3000001, max: 5000000, yen: 80000 },
];

const waveExtraTiers = [
  { min: 200001, max: 300000, yen: 4000 },
  { min: 300001, max: 400000, yen: 6000 },
  { min: 400001, max: 500000, yen: 10000 },
  { min: 500001, max: 600000, yen: 15000 },
  { min: 600001, max: 700000, yen: 20000 },
  { min: 700001, max: 800000, yen: 25000 },
  { min: 800001, max: 900000, yen: 30000 },
  { min: 900001, max: 1000000, yen: 35000 },
  { min: 1000001, max: 2000000, yen: 40000 },
  { min: 2000001, max: 3000000, yen: 100000 },
  { min: 3000001, max: 5000000, yen: 120000 },
];

const LS_KEY = "coin_calc_history_v4";
let currentApp = "wave";
let extraEnabled = false;

// 控除（自動反映・モーダルで変更可）
let invoiceRate = appConfigs[currentApp].invoiceRate;
let withholdingRate = appConfigs[currentApp].withholdingRate;
let feeYen = appConfigs[currentApp].feeYen;

const $ = (id)=>document.getElementById(id);
const clamp0 = (v)=> Math.max(0, Number(v)||0);
const yen = (n)=> "¥" + Math.round(clamp0(n)).toLocaleString("ja-JP");
const nowISO = ()=>{
  const d = new Date(); const p=(x)=>String(x).padStart(2,"0");
  return `${d.getFullYear()}-${p(d.getMonth()+1)}-${p(d.getDate())} ${p(d.getHours())}:${p(d.getMinutes())}:${p(d.getSeconds())}`;
};

function pickTier(coins, tiers){
  const c = clamp0(coins);
  let best = null;
  for(const t of tiers){
    if(c >= t.min && (!best || t.min > best.min)) best = t;
  }
  if(!best) return { yen:0, label:"-" };
  return { yen: best.yen, label: `${best.min.toLocaleString("ja-JP")}〜${best.max.toLocaleString("ja-JP")}` };
}

function calcBase(coins){ return clamp0(coins) * BASE_RATE * PAYOUT_PERCENT; }
function calcBonus(coins){
  if(currentApp === "wave"){
    const t = pickTier(coins, waveNormalTiers);
    return { yen: t.yen, label: t.label };
  }
  return { yen: 0, label: "（未設定）" };
}
function calcExtra(coins){
  if(currentApp !== "wave") return { yen:0, label:"OFF" };
  if(!extraEnabled) return { yen:0, label:"OFF" };
  const t = pickTier(coins, waveExtraTiers);
  return { yen: t.yen, label: `ON / ${t.label}` };
}

function getTotals(){
  const coins = clamp0($("coins").value);
  const base = calcBase(coins);
  const bonus = calcBonus(coins);
  const extra = calcExtra(coins);
  const gross = base + bonus.yen + extra.yen;

  const inv = gross * (invoiceRate/100);
  const wth = gross * (withholdingRate/100);
  const fee = clamp0(feeYen);
  const deduct = inv + wth + fee;
  const net = Math.max(0, gross - deduct);

  return { coins, base, bonus, extra, gross, inv, wth, fee, deduct, net };
}

function syncExtraButtons(){
  $("extraOff").classList.toggle("on", !extraEnabled);
  $("extraOn").classList.toggle("on", extraEnabled);
  $("extraOff").classList.toggle("off", extraEnabled);
  $("extraOn").classList.toggle("off", !extraEnabled);
}

function updateAppUI(){
  const cfg = appConfigs[currentApp];
  $("appNote").textContent = `現在：${cfg.name}`;
  $("waveExtraBlock").style.display = cfg.hasExtra ? "block" : "none";
  if(!cfg.hasExtra) extraEnabled = false;
  syncExtraButtons();

  // アプリごとの初期値へ（必要なら「アプリ切替しても維持」に変更もできる）
  invoiceRate = cfg.invoiceRate;
  withholdingRate = cfg.withholdingRate;
  feeYen = cfg.feeYen;

  $("invoiceRate").value = invoiceRate;
  $("withholdingRate").value = withholdingRate;
  $("feeYen").value = feeYen;

  updateView();
}

function updateView(){
  const t = getTotals();

  $("baseYen").textContent = yen(t.base);
  $("baseFormula").textContent = `${t.coins.toLocaleString("ja-JP")} × 0.2 × 40%`;

  $("bonusYen").textContent = yen(t.bonus.yen);
  $("bonusHint").textContent = (currentApp==="wave") ? `適用：${t.bonus.label}` : t.bonus.label;

  $("extraYen").textContent = yen(t.extra.yen);
  $("extraHint").textContent = t.extra.label;

  $("grossYen").textContent = yen(t.gross);
  $("deductYen").textContent = yen(t.deduct);
  $("netYen").textContent = yen(t.net);
  $("netNote").textContent = `${yen(t.gross)} − ${yen(t.deduct)} = ${yen(t.net)}`;

  $("mGross").textContent = yen(t.gross);
  $("mInvoice").textContent = yen(t.inv);
  $("mWithhold").textContent = yen(t.wth);
  $("mFee").textContent = yen(t.fee);
  $("mDeduct").textContent = yen(t.deduct);
  $("mNet").textContent = yen(t.net);

  localStorage.setItem("coin_calc_last_v4", JSON.stringify({
    currentApp, extraEnabled,
    coins: $("coins").value ?? "",
    memo: $("memo").value ?? "",
    invoiceRate, withholdingRate, feeYen
  }));
}

/* ===== history (保存のみ・表示なし) ===== */
function loadHistory(){
  try{ return JSON.parse(localStorage.getItem(LS_KEY) || "[]"); }
  catch(e){ return []; }
}
function saveHistory(list){
  localStorage.setItem(LS_KEY, JSON.stringify(list));
}
function addCurrentToHistory(){
  const t = getTotals();
  const item = {
    date: nowISO(),
    app: appConfigs[currentApp].name + (currentApp==="wave" && extraEnabled ? "（EX ON）" : ""),
    memo: ($("memo").value || "").trim(),
    coins: t.coins,
    baseYen: Math.round(t.base),
    bonusYen: Math.round(t.bonus.yen),
    extraYen: Math.round(t.extra.yen),
    grossYen: Math.round(t.gross),
    invoiceRate, withholdingRate, feeYen,
    deductYen: Math.round(t.deduct),
    netYen: Math.round(t.net),
  };
  const list = loadHistory();
  list.unshift(item);
  saveHistory(list);
}

/* ===== CSV (今回の結果1行) ===== */
function csvCell(v){
  const s = String(v ?? "").replaceAll('"','""');
  if(/[",\n\r]/.test(s)) return `"${s}"`;
  return s;
}

/* ===== modal ===== */
function openModal(){
  $("modalBack").style.display = "flex";
  updateView();
}
function closeModal(){
  $("modalBack").style.display = "none";
}

/* ===== init ===== */
document.addEventListener("DOMContentLoaded", () => {
  // tabs
  document.querySelectorAll("#tabs .tab").forEach(btn=>{
    const handler = (e)=>{
      e.preventDefault();
      document.querySelectorAll("#tabs .tab").forEach(b=>b.classList.remove("active"));
      btn.classList.add("active");
      currentApp = btn.dataset.app;
      updateAppUI();
    };
    btn.addEventListener("pointerup", handler);
    btn.addEventListener("click", handler);
  });

  // extra buttons
  $("extraOff").addEventListener("click", ()=>{ extraEnabled=false; syncExtraButtons(); updateView(); });
  $("extraOn").addEventListener("click", ()=>{ extraEnabled=true;  syncExtraButtons(); updateView(); });

  // inputs
  ["coins","memo"].forEach(id=>{
    const el = $(id);
    ["input","change","keyup"].forEach(ev=> el.addEventListener(ev, updateView, {passive:true}));
  });

  // modal
  $("openDeduct").addEventListener("click", openModal);
  $("closeDeduct").addEventListener("click", closeModal);
  $("modalBack").addEventListener("click", (e)=>{ if(e.target === $("modalBack")) closeModal(); });

  $("applyRates").addEventListener("click", ()=>{
    invoiceRate = clamp0($("invoiceRate").value);
    withholdingRate = clamp0($("withholdingRate").value);
    feeYen = clamp0($("feeYen").value);
    updateView();
    closeModal();
  });
  $("resetRates").addEventListener("click", ()=>{
    const cfg = appConfigs[currentApp];
    invoiceRate = cfg.invoiceRate;
    withholdingRate = cfg.withholdingRate;
    feeYen = cfg.feeYen;
    $("invoiceRate").value = invoiceRate;
    $("withholdingRate").value = withholdingRate;
    $("feeYen").value = feeYen;
    updateView();
  });

  // history buttons
  $("save").addEventListener("click", ()=>{ updateView(); addCurrentToHistory(); });
  $("clearInput").addEventListener("click", ()=>{
    $("coins").value = "";
    $("memo").value = "";
    extraEnabled = false;
    syncExtraButtons();
    updateView();
  });
  $("wipe").addEventListener("click", ()=>{
    if(!confirm("履歴を全削除します。よろしいですか？")) return;
    localStorage.removeItem(LS_KEY);
    alert("履歴を削除しました");
  });

  // CSV single export
  $("exportSingleCsv").addEventListener("click", ()=>{
    const t = getTotals();
    const headers = ["date","app","memo","coins","baseYen","bonusYen","extraYen","grossYen","invoiceRate","withholdingRate","feeYen","deductYen","netYen"];
    const row = [
      nowISO(),
      appConfigs[currentApp].name + (currentApp==="wave" && extraEnabled ? "（EX ON）" : ""),
      ($("memo").value||"").trim(),
      t.coins,
      Math.round(t.base),
      Math.round(t.bonus.yen),
      Math.round(t.extra.yen),
      Math.round(t.gross),
      invoiceRate,
      withholdingRate,
      Math.round(t.fee),
      Math.round(t.deduct),
      Math.round(t.net)
    ];
    const csv = headers.join(",") + "\n" + row.map(v=>csvCell(v)).join(",");
    const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `coin_result_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  });

  // restore last
  try{
    const last = JSON.parse(localStorage.getItem("coin_calc_last_v4") || "null");
    if(last){
      currentApp = last.currentApp || "wave";
      extraEnabled = !!last.extraEnabled;
      $("coins").value = last.coins ?? "";
      $("memo").value = last.memo ?? "";
      invoiceRate = (typeof last.invoiceRate === "number") ? last.invoiceRate : appConfigs[currentApp].invoiceRate;
      withholdingRate = (typeof last.withholdingRate === "number") ? last.withholdingRate : appConfigs[currentApp].withholdingRate;
      feeYen = (typeof last.feeYen === "number") ? last.feeYen : appConfigs[currentApp].feeYen;
    }
  }catch(e){}

  // set active tab
  document.querySelectorAll("#tabs .tab").forEach(b=>{
    b.classList.toggle("active", b.dataset.app === currentApp);
  });

  // initial
  $("invoiceRate").value = invoiceRate;
  $("withholdingRate").value = withholdingRate;
  $("feeYen").value = feeYen;

  updateAppUI();
  updateView();
});
</script>
</body>
</html>
